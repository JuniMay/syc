# SysY Compiler

## Getting Started

### Development

1. `sudo apt install flex cmake clang`
2. install bison 3.8
   1. `wget http://ftp.gnu.org/gnu/bison/bison-3.8.tar.gz`
   2. `tar -zxvf bison-3.8.tar.gz`
   3. `cd bison-3.8`
   4. `./configure`
   5. `make`
   6. `sudo make install`
   7. `sudo ln -s /usr/local/bin/bison /usr/bin/bison`
3. Generate the parser and lexer using `yacc_gen.sh` under scripts directory.
4. Build using cmake.

### Tests

The machanism of the contest is compiling everything altogether. So we need to flatten the source code.

```shell
python3 tests/execute.py
```

This will generate the `syc` executable in the current directory.

### Debug

To cross debug, we need to install `gdb-multiarch`.

```shell
sudo apt install gdb-multiarch
```

Compile the assembly generated by syc:

```shell
riscv64-linux-gnu-gcc -march=rv64gc ./tests/test.s -L./sysy-runtime-lib -lsylib -o ./tests/test
```

Use QEMU to run the program. This will listen on port 1234.

```shell
qemu-riscv64 -L /usr/riscv64-linux-gnu -g 1234 ./tests/test < ./tests/test.in &
```

Use GDB to connect to QEMU. This will load the symbols in the executable.

```shell
gdb-multiarch ./tests/test
```

In GDB, connect to QEMU.

```shell
target remote :1234
```

Then just debug.

## Todo List

- [x] Try to use temporary register for temporary immediate loading.
  - t0, t1, ft0, ft1, ft2 is used in spilling virtual registers.
  - t2 is used in codegen for temporary immediate loading, pseudo load/store and comparison.
- [ ] Unreachable elimination.
  - [ ] Fix `functional/51_short_circuit`
  - [ ] Fix `functional/75_max_flow`
  - [ ] Fix `functional/82_long_func`
- [x] Strength reduction
  - [x] IR: integer multiplication to shift.
  - [x] IR: integer division by 2 to shift.
  - [x] IR: integer division by 2^k to shift.
- [ ] unmodified variable to constant
- [ ] Loop optimization
  - [x] Loop invariant code motion
  - [ ] Loop induction variable optimization
  - [ ] Unrolling
  - [ ] Parallelization
- [ ] Redundant code elimination after register allocation
- [ ] additional ir peephole for add %i, 0
- [ ] if condition simplification
  - [ ] if (a / c0 >= c1) -> if (a > c0 * c1 - 1)
- [ ] loop interchange for `performance/01_mmx.sy`
- [ ] function common subexpression elimination
